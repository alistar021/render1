# file: main.py
from fastapi import FastAPI, Request
from telegram import Bot, Update, InlineKeyboardButton, InlineKeyboardMarkup
import uvicorn
import os

# ======= ØªÙ†Ø¸ÛŒÙ…Ø§Øª =======
TOKEN = "8476998300:AAGY2UnyUcrhm29IBvg8BYyCXgRxy73GvVY"
CHANNEL_ID = "@alialisend123"
FINAL_LINK = "https://t.me/azadborojerd"
bot = Bot(token=TOKEN)
# ========================

app = FastAPI()

# Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Øª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
user_data = {}

# Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ø§ Ø¯Ú©Ù…Ù‡
async def send_keyboard(chat_id, text):
    keyboard = [[InlineKeyboardButton("âœ… Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ", callback_data="final_click")]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    bot.send_message(chat_id=chat_id, text=text, reply_markup=reply_markup)

# Ù…Ø³ÛŒØ± Webhook
@app.post(f"/{TOKEN}")
async def telegram_webhook(request: Request):
    update = Update.de_json(await request.json(), bot)

    chat_id = None
    if update.message:
        chat_id = update.message.chat.id
        text = update.message.text
        user_id = update.message.from_user.id

        if text == "/start":
            user_data[user_id] = {}
            bot.send_message(chat_id, "ğŸ‘‹ Ø³Ù„Ø§Ù…! Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø®ÙˆØ¯Øª Ø±Ùˆ Ø¨ÙØ±Ø³Øª ğŸ™")
        else:
            data = user_data.get(user_id, {})
            if "name" not in data:
                data["name"] = text
                user_data[user_id] = data
                bot.send_message(chat_id, f"ğŸ“Œ Ø¹Ø§Ù„ÛŒ {text}! Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø®ÙˆØ¯Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†:")
            elif "phone" not in data:
                data["phone"] = text
                bot.send_message(chat_id, "ğŸ“ Ø­Ø§Ù„Ø§ Ø±Ø´ØªÙ‡ ØªØ­ØµÛŒÙ„ÛŒ Ø®ÙˆØ¯Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†:")
            elif "field" not in data:
                data["field"] = text
                # Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„
                caption = f"ğŸ‘¤ Ù†Ø§Ù…: {data['name']}\nğŸ“ Ø´Ù…Ø§Ø±Ù‡: {data['phone']}\nğŸ“ Ø±Ø´ØªÙ‡: {data['field']}\nUsername: @{update.message.from_user.username if update.message.from_user.username else 'Ù†Ø¯Ø§Ø±Ø¯'}\nChat ID: {chat_id}"
                bot.send_message(CHANNEL_ID, caption)
                await send_keyboard(chat_id, "ğŸ‰ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯! Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯:")

    if update.callback_query:
        query = update.callback_query
        bot.send_message(query.message.chat.id, f"ğŸ™ Ù…Ù…Ù†ÙˆÙ†!\nğŸ’¬ Ù…Ø§Ø±Ø§ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†ÛŒØ¯:\n{FINAL_LINK}")
        if query.from_user.id in user_data:
            del user_data[query.from_user.id]

    return "ok"

# Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø­Ù„ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=int(os.environ.get("PORT", 8000)))
