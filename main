# file: main.py
from fastapi import FastAPI, Request
from telegram import Bot, Update, InlineKeyboardButton, InlineKeyboardMarkup
import uvicorn
import os

# ======= تنظیمات =======
TOKEN = "8476998300:AAGY2UnyUcrhm29IBvg8BYyCXgRxy73GvVY"
CHANNEL_ID = "@alialisend123"
FINAL_LINK = "https://t.me/azadborojerd"
bot = Bot(token=TOKEN)
# ========================

app = FastAPI()

# ذخیره موقت داده‌های کاربران
user_data = {}

# ارسال پیام با دکمه
async def send_keyboard(chat_id, text):
    keyboard = [[InlineKeyboardButton("✅ ثبت نهایی", callback_data="final_click")]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    bot.send_message(chat_id=chat_id, text=text, reply_markup=reply_markup)

# مسیر Webhook
@app.post(f"/{TOKEN}")
async def telegram_webhook(request: Request):
    update = Update.de_json(await request.json(), bot)

    chat_id = None
    if update.message:
        chat_id = update.message.chat.id
        text = update.message.text
        user_id = update.message.from_user.id

        if text == "/start":
            user_data[user_id] = {}
            bot.send_message(chat_id, "👋 سلام! لطفاً نام و نام خانوادگی خودت رو بفرست 🙏")
        else:
            data = user_data.get(user_id, {})
            if "name" not in data:
                data["name"] = text
                user_data[user_id] = data
                bot.send_message(chat_id, f"📌 عالی {text}! لطفاً شماره موبایل خودت را وارد کن:")
            elif "phone" not in data:
                data["phone"] = text
                bot.send_message(chat_id, "📝 حالا رشته تحصیلی خودت را وارد کن:")
            elif "field" not in data:
                data["field"] = text
                # ارسال اطلاعات کامل به کانال
                caption = f"👤 نام: {data['name']}\n📞 شماره: {data['phone']}\n🎓 رشته: {data['field']}\nUsername: @{update.message.from_user.username if update.message.from_user.username else 'ندارد'}\nChat ID: {chat_id}"
                bot.send_message(CHANNEL_ID, caption)
                await send_keyboard(chat_id, "🎉 اطلاعات شما ثبت شد! برای ثبت نهایی روی دکمه زیر کلیک کنید:")

    if update.callback_query:
        query = update.callback_query
        bot.send_message(query.message.chat.id, f"🙏 ممنون!\n💬 مارا در کانال دنبال کنید:\n{FINAL_LINK}")
        if query.from_user.id in user_data:
            del user_data[query.from_user.id]

    return "ok"

# اجرای محلی (اختیاری)
if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=int(os.environ.get("PORT", 8000)))
